<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Appointment Form</title>
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/reynaldoslogo.png">
    <meta name="description" content="This is the Login page">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,400i,700,700i,600,600i">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bebas+Neue&amp;display=swap">
    <link rel="stylesheet" href="assets/fonts/simple-line-icons.min.css">
    <link rel="stylesheet" href="assets/css/about_us_extra.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.10.0/baguetteBox.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.13.18/jquery.timepicker.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.css">
    <link rel="stylesheet" href="assets/css/vanilla-zoom.min.css">
    <link rel="stylesheet" href="assets/css/services.css">
    <link rel="stylesheet" href="assets/css/hover_button.css">
    <link rel="stylesheet" href="./Calendar/style.css">
    <link rel="stylesheet" href="assets/css/imagesliderpanels.css">
    <link rel="stylesheet" href="assets/css/parallelogram.css">

    <style>
         .terms-modal{
            max-height: 70vh;
            overflow-y: auto;
           
        }

        .ui-datepicker,
        .ui-timepicker-div {
            z-index: 9999 !important;  /* Adjust this value if needed */
        }

        .terms-content{
            word-wrap: break-word; 
            width: 500px;
        }

        .card-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);

        }

        body{
            background-image: url(assets/img/secondbackgroundindex.png);
        }

        label{
            font-family: Montserrat;
            font-weight: bold;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"]{
            width: 500px;
            text-align: left; 
            border: 1px solid #ccc;
            border-radius: 10px;
            box-sizing: border-box;
            padding: 5px;
            margin: 5px;
        }

        .schedule{
            width: 100%;
            display: flex;
        }

        #vehicle, #preferredMechanic{
            width: 500px;
            text-align: left; 
            border: 1px solid #ccc;
            border-radius: 10px;
            box-sizing: border-box;
            padding: 5px;
            margin: 5px;
        }

        h3{
            font-weight: bold;
            text-align: center;
        }


        @media (max-width: 768px) {
        

        input[type="text"],
        input[type="email"],
        input[type="password"]{
            width: 300px;
        }

        #vehicle,  #preferredMechanic{
            width: 300px;
        }

        .terms-content{
            width: auto;
        }

        .container{
            padding: 0px !important;
        }

        }

        @media (max-width: 1024px) {
            input[type="text"],
        input[type="email"],
        input[type="password"]{
            width: 300px;
        }

        #vehicle,  #preferredMechanic{
            width: 300px;
        }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark navbar-expand-lg fixed-top clean-navbar" style="background: #051129;">
        <div class="container">
            <a class="navbar-brand logo" href="homepage.html"><img class="img-fluid" src="assets/img/reynaldoslogo.png" width="70px" style="margin: 0px;padding: 0px;" href="homepage.html"></a>
        </div>
    </nav>
    
        
    <main>
        <div class="container " style="margin-top: 200px; padding: 20px;">
            <form id="appointmentForm" method="POST" class="form-container mt-4 mb-5">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h3>Customer Information</h3>
                                <label for="name">Name: <br><input type="text" placeholder="Enter your name here.. " name="name" id="name" required></label>
                                <label for="phonenumber">Phone #: <br><input type="text" name="phonenumber" placeholder="+63" id="phonenumber" required></label>
                                <label for="email">Email: <br><input type="text" name="email" placeholder="example@gmail.com" id="email" required></label>
                                <label for="city">City/Address: <br><input type="text" name="city" placeholder="City" id="city"></label>
                                <!-- <label for="platenum">Plate Number: <br><input type="text" name="platenum" placeholder="Enter your plate number.." id="platenum" required></label> -->
                                <div>
                                    <label for="vehicle">Vehicle:</label>
                                    <select name="Vehicle" id="vehicle" style="height: auto;" required>
                                        <option value="" disabled selected>Select Existing Vehicle:</option>
                                    </select>
                                </div>
                                
                                    <div class="col-12">
                                        <p class="mb-0" style="opacity: .7; font-size: 14px;"><i><b><strong>Note: </strong></b>If you want to add a new vehicle, click the button below</i></p>
                                        <button 
                                            class="btn btn-primary me-1" 
                                            style="background-color: darkred; width: 200px"
                                            onclick="window.location.href='userdashboard-myvehicle.html';">
                                            New Vehicle?
                                        </button>
                                    </div>
                               
                                
                                <div>
                                    <br>
                                    <p><strong>Optional:</strong></p>
                                    <label for="preferredMechanic">Preferred Mechanic:</label>
                                    <select name="preferredMechanic" id="preferredMechanic"required>
                                        <option value="" disabled selected>Select Preferred Mechanic</option>
                                    </select>
                                </div>
                                
                                <h3 class="mt-3">Suggestions or Comments</h3>
                                <label for="suggestions">Please provide any additional comments or needs:</label>
                                <textarea class="col-md-12 mt-2" id="suggestions" name="suggestions" rows="4" style="width: 100%;" placeholder="Enter your suggestions or comments here..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <h3>Schedule Information</h3>
                                    <div class="col-md-12 mt-1">
                                        <label for="datetimepicker ">Select Date and Time:</label>
                                        <input type="text" name="datetimepicker" id="datetimepicker" placeholder="MM/DD/YYYY HH:MM" required>
                                    </div>
                                    
                                    <!-- 
                                        <div class="col-md-12">
                                        <button id="show-slots-btn" type="button">Show Available Slots</button>
                                        </div>
                                    -->
                                    <div class="col-7 mt-3">
                                        <p style="opacity: .7; font-size: 14px;"><i><b><strong>Note: </strong></b>Advance your selecting time in 30mins, incase your are not attend on exact time.</i></p>
                                    </div>
                                    <h3 class="mt-4">Additional Information</h3>
                                    <div class="col-5">
                                        <label>Is the car functional?</label>
                                        <label for="yesBtn"><input type="radio" id="yesBtn" name="carfunc" value="yes">Yes</label>
                                        <label for="noBtn"><input type="radio" id="noBtn" name="carfunc" value="no">No</label>
                                    </div>
                                    <div class="col-7 mt-3">
                                        <p style="opacity: .7; font-size: 14px;"><i><b><strong>Note: </strong></b>Clicking the "No" button will inform us that you possibly need help for Towing Purposes which will be added to the Estimated Price Breakdown below. Contact us for more details.</i></p>
                                    </div>
                                </div>
                                
                                
<!-- 
<input type="hidden" id="selected-slot" name="slot">
        
                                
                                <div id="slots-popup" class="popup" style="display:none;">
                                    <div class="popup-content">
                                        <span class="close">&times;</span>
                                        <h2>Available Slots</h2>
                                        <div id="slots">
                                             Add radio buttons or other selectors for selecting slots
                                            <label><input type="radio" class="slot" name="slot" value="1"> Slot 1</label>
                                            <label><input type="radio" class="slot" name="slot" value="2"> Slot 2</label>
                                             Add more slots as needed
                                        </div>
                                        <p id="availability">Slots Available: <span id="available-slots">26</span></p>
                                        <button id="confirm-btn" type="button">Confirm</button>
                                    </div>
                                </div>
                            -->
                                <div class="col-md-12"><br>
                                    <div class="card p-3 mb-3" style="background-color: rgb(246, 246, 246);">
                                        <h5><b><strong>Estimated Price Breakdown:</strong></b> </h5>
                                        <div id="service-list"></div>
                                        <p><b>Service Estimation:</b> <span id="service-estimation">₱ 0</span></p>
                                        <p><b>Towing Fee:</b> <span id="towingFee">####</span></p>
                                        <p><b>Processing Fee: <span style="color: Red;">₱ 500.00</span></b><br>  
                                        <p><b>Grand Total:</b> <span id="grand-total">₱ 0</span></p>
                                        <p style="opacity: .7; font-size: 14px;"><i><b><strong>Note: </strong></b>Price varies upon actual inspection of the vehicle. This is simply an estimation.</i></p>

                                    </div>
                                    
                                    <!-- Checkbox for Terms Acceptance -->
                                    <input class="form-check-input mt-3 me-2" type="checkbox" name="terms" id="termsCheckbox" required style="display: inline-block !important;">
                                    <label class="form-check-inline">I have read &amp; accepted the <a href="#" id="terms-link" data-bs-toggle="modal" data-bs-target="#termsModal">Terms and Conditions</a></label>

                                    <br><br>
                                    <p style="opacity: .7; font-size: 14px;"><i><b><strong>Note: </strong></b>Agreeing to the Terms and Conditions and clicking "Next" it will send to your Email Account for the Payment Processing. This will require you to pay P500 as Processing Fee.<br><br> See "Terms and Conditions" for more details.</i></p>
                                    <br>
                                </div>
                
                            <!-- Submit Button -->
                            <div class="col-12">
                                <button type="submit" id="submit-slots-btn">Next</button>
                            </div>
                
                            <!-- Success message 
                            <div id="success-message" style="display:none; margin-top: 20px;" class="alert alert-success">
                                Your appointment has been submitted successfully! Proceeding to Payment now..
                            </div>-->
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

                
            </form>
        </div>
    </div>
        <div class="parallelogram">Appointment Form</div>
    </main>

    <!-- Modal Structure for Terms and Conditions -->
        <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: darkred; color: white;">
                        <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: rgb(255, 255, 255);"></button>
                    </div>
                    <div class="modal-body">
                        <div class="terms-content">
                            <p>These terms and conditions outline the rules and regulations for the use of Reynaldo's Car Care Center's services.</p>
                            <p>By booking an appointment, you agree to these terms and conditions. Please read them carefully.</p>
                            <p><strong>Service Estimation:</strong> The estimated price for services is subject to change based on the actual inspection of the vehicle.</p>
                            <p><strong>Processing Fee:</strong> The processing fee is non-refundable and is required to confirm your appointment, but it will be deducted from the actual price of the service once you're fully committed to acquiring our service.</p>
                            <p><strong>Towing Service:</strong> If the car is non-functional, an additional fee will be charged for towing services.</p>
                            <p><strong>Privacy Policy:</strong> Your personal information will be handled with care and will not be shared with third parties without your consent.</p>
                            <p>For more details, please contact us.</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
$(document).ready(function () {

const selectedServices = JSON.parse(localStorage.getItem('selectedServices')) || [];
let serviceTotal = 0;

// Populate the service list and calculate the total
selectedServices.forEach(service => {
    serviceTotal += service.price;
    $('#service-list').append(`<p>${service.name}: ₱${service.price.toFixed(2)}</p>`);
});

async function populateMechanicsDropdown() {
    try {
        const response = await fetch('/api/mechanics');
        if (!response.ok) {
            throw new Error(`Failed to fetch mechanics: ${response.statusText}`);
        }
        const mechanics = await response.json();

        if (!mechanics || mechanics.length === 0) {
            console.warn('No mechanics available');
            alert('No preferred mechanics available.');
            return;
        }

        // Populate dropdown
        const preferredMechanicDropdown = $("#preferredMechanic");
        preferredMechanicDropdown.empty(); // Clear previous options
        preferredMechanicDropdown.append('<option value="" disabled selected>Select Preferred Mechanic</option>');
        mechanics.forEach((mechanic) => {
            const optionText = `${mechanic.name} - ${mechanic.specialization} - Status: ${mechanic.availability.toUpperCase()}`;
            preferredMechanicDropdown.append($("<option></option>").text(optionText).val(mechanic._id));
        });
    } catch (error) {
        console.error('Error fetching mechanics:', error);
        alert('Failed to load preferred mechanics.');
    }
}

// Ensure function runs after DOM is fully loaded
$(document).ready(() => {
    populateMechanicsDropdown();
});



// Display the total service estimation
$('#service-estimation').text(`₱${serviceTotal.toFixed(2)}`);

// Add additional fees, such as the appointment fee
const appointmentFee = 0;
const grandTotal = serviceTotal + appointmentFee;
$('#grand-total').text(`₱${grandTotal.toFixed(2)}`);

// Fetch user and vehicle data from backend
const email = localStorage.getItem('userEmail');
if (email) {

    $.ajax({
        url: `/customer/${email}`,
        type: 'GET',
        success: function (customer) {
            // Populate form fields
            $('#name').val(customer.name || '');
            $('#phonenumber').val(customer.phonenumber || '');
            $('#email').val(customer.email || '');
            $('#city').val(customer.city || '');

            // Populate vehicle dropdown
            const vehicleDropdown = $('#vehicle');
            vehicleDropdown.empty();
            customer.vehicles.forEach(vehicle => {
                const optionText = `${vehicle.brand} - ${vehicle.model} - (${vehicle.yearModel}) - ${vehicle.color}`;
                const option = $('<option></option>').text(optionText).val(vehicle.plateNumber);
                vehicleDropdown.append(option);
            });
        },
        error: function (xhr) {
            console.error('Error fetching customer data:', xhr.responseText);
            alert('Failed to load customer data. Please try again.');
        }
    });
} else {
    alert('User email not found. Please log in again.');
    window.location.href = 'login.html';
}

    // Function to fetch blocked slots for the selected date
    function fetchBlockedSlots(selectedDate) {
        return $.ajax({
            url: `/appointments/blocked-slots?date=${selectedDate}`,
            method: 'GET',
            error: function () {
                alert('Failed to fetch blocked slots. Please try again.');
            }
        });
    }

    // Initialize datetimepicker
    $('#datetimepicker').datetimepicker({
        dateFormat: 'mm/dd/yy',
        timeFormat: 'hh:mm tt',
        minDate: 0, // Disable past dates
        stepMinute: 30, // Time intervals
        hourMin: 8, // Start time: 8:00 AM
        hourMax: 16, // End time: 4:00 PM
        beforeShowDay: function (date) {
            // Example to disable Sundays
            return [date.getDay() !== 0, ""];
        },
        onSelect: function (datetimeText) {
            const [selectedDate] = datetimeText.split(" ");
            fetchBlockedSlots(selectedDate).done((blockedSlots) => {
                $(".ui-timepicker-list li").each(function () {
                    const time = $(this).text().trim();
                    if (blockedSlots.includes(time)) {
                        $(this).addClass('ui-state-disabled').attr('disabled', true);
                    }
                });
            });
        }
    });

    // Validate and clear blocked times
    $('#datetimepicker').on('change', function () {
        const datetime = $(this).val();
        const [selectedDate, selectedTime] = datetime.split(" ");

        fetchBlockedSlots(selectedDate).done((blockedSlots) => {
            if (blockedSlots.includes(selectedTime)) {
                alert('The selected time is already booked. Please choose another time.');
                $(this).val(''); // Clear invalid selection
            }
        });
    });

// Set towing fee based on car functionality
$('input[name="carfunc"]').change(function () {
    const towingFeeElement = $('#towingFee');

    if ($('#noBtn').is(':checked')) {
        towingFeeElement.html('<i><strong>The towing fee would be depends on the distance of your place and will be negotiated with the owner</strong></i>'); 
        towingFeeElement.css('opacity', '0.7');
        towingFeeElement.css('fontSize', '14px');
    } else if ($('#yesBtn').is(':checked')) {
        towingFeeElement.text('####'); // Clear towing fee if "Yes" is selected
    }
});

// Submit form with DateTime and slot info
$('#appointmentForm').on('submit', function (event) {
    event.preventDefault();

    const datetimepicker = $('#datetimepicker').val();
    

    // Collect form data
    const formData = {
        phonenumber: $('#phonenumber').val(),
        email: $('#email').val(),
        city: $('#city').val(),
        vehicle: $('#vehicle').val(),
        carfunc: $('input[name="carfunc"]:checked').val(),
        platenum: $('#platenum').val(),
        suggestions: $('#suggestions').val(),
        datetime: datetimepicker,
        preferredMechanic: $("#preferredMechanic").val(),
        selectedServices: selectedServices.map(service => ({
        ...service,
        mechanic: service.mechanic || 'Default Mechanic', // Add mechanic if missing
    }))
     
    };

    console.log('Form Data:', formData);

    // AJAX POST request
    $.ajax({
        url: '/appointment',
        type: 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        success: function (response) {
            alert(response.message);
            localStorage.setItem('userEmail', $('#email').val());
            
                if (response.redirectUrl) {
                    window.location.href = response.redirectUrl;
            }
        },
        error: function (jqXHR, textStatus, errorThrown) {
            console.error('Error:', textStatus, errorThrown);
            console.error('Response Text:', jqXHR.responseText);
            alert('An error occurred. Please try again.');
        }
    });
});

// Handle Terms & Conditions Modal
$('#terms-link').on('click', function (event) {
    event.preventDefault();
    $('#terms-modal').show();
});

$('.close-btn').on('click', function () {
    $('#terms-modal').hide();
});

// Clear localStorage for selected services after page load
localStorage.removeItem('selectedServices');
});
    </script> 
    
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.10.0/baguetteBox.min.js"></script>
    <script src="assets/js/vanilla-zoom.js"></script>
    <script src="assets/js/theme.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.js"></script>
    <script src="./Calendar/script.js"></script>
    <script src="./Appointment/appointment.js"></script>
</body>

</html>
    