<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Registration Form</title>
    <meta name="description" content="This is the Login page">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,400i,700,700i,600,600i">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bebas+Neue&amp;display=swap">
    <link rel="stylesheet" href="./Appointment/appointment.css">
    <link rel="stylesheet" href="assets/css/parallelogram.css">

    <style>
         .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        #addVehicleButton{
            background-color: black;
        }

        .image-preview {
            width: 200px; /* Set fixed width */
            height: 200px; /* Set fixed height */
            border: 1px solid #ccc; /* Optional: add a border */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Ensure content does not overflow */
        }
        .image-preview img {
            max-width: 100%; /* Ensure the image fits within the container */
            max-height: 100%; /* Ensure the image fits within the container */
            object-fit: cover; /* Maintain aspect ratio */
        }

        h3{
            font-family: "Bebas Neue";
            font-weight: lighter;
            font-size: 40px;
        }

        .input-group .form-control {
            border-radius: 20px 0 0 20px;
            border-right: none;
        }

        .input-group .btn {
            border-radius: 0 20px 20px 0;
            background-color: black;
            color: #ffcccc;
            margin-top: 27px;
        }

        .input-group .btn:hover {
            background-color: #333;
        }

        .edit-btn, .delete-btn{
            width: 80%;
            margin: 0 auto;
            align-items: center;
        }
        
        @media (max-width: 768px) {
        .responsive-textbox {
            column-width: 100%;   /* Ensures the textbox fills the entire width */
            box-sizing: content-box;
        }
        }
   

    </style>
</head>

<body>
    <nav class="navbar navbar-dark navbar-expand-lg fixed-top clean-navbar" style="background: #051129;">
        <div class="container">
            <a class="navbar-brand logo" href="index.html"><img class="img-fluid" src="assets/img/reynaldoslogo.png" width="70px" style="margin: 0px;padding: 0px;" href="index.html"></a>
            <h3 style="color:white">Registration Form</h3>
        </div>
    </nav>
    
    <main>
        
        <form id="registrationForm" class="form-container mt-4" >
            <div class="row">
            
                <div class="col-md-12 mb-4">
                   
                </div>
                
                <div class="col-md-6">
                    <div class="row">
                        <h3 class="mt-4">Customer Information</h3>
                        <div class="col-md-6">
                            <label for="name">Name: <input type="text" placeholder="Name" name="Type your name here.. " id="name" required></label>
                        </div>
                        <div class="col-md-6">
                            <label for="phonenumber" >Phone #: <input type="text" placeholder="+63" name="Phonenumber" id="phonenumber" required></label>
                        </div>
                        <div class="col-md-6 mt-3">
                            <label for="email responsive-textbox">Email: <input type="email" placeholder="example@gmail.com" name="email" id="email" required></label>
                        </div>
                       

                        <div class="container my-4 col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control mt-4" placeholder="Enter Code" id="verificationCode" required>
                                <div class="input-group-append">
                                    <button class="btn" type="button" id="getCodeButton">Get Code</button>
                                </div>
                            </div>
                        </div>
                        
                       
                        <div class="col-md-4 mb-2">
                            <label for="city">City: <input type="text" placeholder="City"  name="City" id="city"></label>
                        </div>
                        <div class="col-md-4">
                            <label for="password">Password: <input type="password" placeholder="********"  name="Password" id="password" required></label>
                        </div>
                        <div class="col-md-4">
                            <label for="password">Confirm Password: <input type="password" placeholder="********"  name="Password" id="confirmpassword" required></label>
                        </div>   
                    </div>
                </div>
                

                <div class="col-md-6">
                    <!--Dropdown list-->
                    <h3 class="mt-4">Vehicle Information</h3>

                    <div class="vehicle-list" id="vehicleList"></div>

                    <button type="button" class="btn btn-primary" id="addVehicleButton" data-bs-toggle="modal" data-bs-target="#vehicleModal">
                        Add New Vehicle
                    </button>                    
                </div>
                <button type="submit" class="btn btn-success mt-4" style="background-color: darkred; width: 25%; margin:0 auto;">Submit</button>
            </div>
        </form>
        <div class="parallelogram">Setting Up Your Account..</div>
    </main>

<!-- Vehicle Modal -->
<div class="modal fade" id="vehicleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: darkred; color: white;" >
                <h5 class="modal-title" >Add Vehicle Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="background-color: rgb(255, 255, 255);"></button>
            </div>
            <div class="modal-body">
                <form id="vehicleForm">
                    <div class="row">
                        <div class="col-md-6">                    
                            <label for="brandModel">Brand Model: <input type="text" placeholder="Example: Toyota Avanza" name="BrandModel" id="brandModel" required></label>
                        </div>
                        <div class="col-md-6">                    
                            <label for="color">Color: <input type="text" placeholder="Example: Candy Red" name="Color" id="color" required></label>
                        </div>
                        <div class="col-md-4">                    
                            <label for="platenum">Plate #: <input type="text" placeholder="ABC 1234" maxlength="8" name="PlateNumber" id="platenum" required></label>
                        </div>
                        <div class="col-md-4">                    
                            <label for="yearmodel">Year Model: <input type="text" placeholder="2024" minlength="4" maxlength="4" name="YearModel" id="yearmodel" required></label>
                        </div>

                        <div class="col-md-4"> 
                            <label for="transmission">Transmission: 
                                <select id="transmission" required>
                                    <option disabled selected>Select Transmission</option>
                                    <option>Automatic</option>
                                    <option>Manual</option>
                                    <option>CVT</option>
                                    <option>Dual Clutch</option>
                                </select>
                            </label>
                        </div>

                        <div class="col-md-6">
                            <label for="vehicleImage" class="mb-3">Vehicle Image (optional): 
                                <input type="file" accept="image/*" name="VehicleImage" id="vehicleImage" class="mt-2" onchange="previewImage(event)">
                            </label>
                            <div id="imagePreview" class="image-preview">
                                <img id="preview" src="#" alt="Image Preview" style="display: none;">
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm mt-2" id="removeImageButton" onclick="removeImage()" style="display: none;">
                                Remove Image
                            </button>
                        </div>
                        <div class="col-md-6 mt-5">
                            <br>
                            <p style="opacity: .5; font-size: 14px;"><i>Note: Reynaldo's Car Care Center doesn't accomodate Electric Vehicles.</i></p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveVehicleButton" style="background-color: rgb(0, 0, 0); color: white;">Save Vehicle</button>
            </div>
        </div>
    </div>
</div>
    
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let vehicles = [];  // Global array to store all vehicle information
    let vehicleCount = 0;
    let isEditing = false;
    let currentItem = null; // Store the item being edited

    $(document).ready(function () {
        // Function to preview the selected image
        function previewImage(event) {
            const preview = document.getElementById('preview');
            const file = event.target.files[0];
            const reader = new FileReader();
            const removeButton = document.getElementById('removeImageButton');

            reader.onload = function() {
                preview.src = reader.result;
                preview.style.display = 'block';
                removeButton.style.display = 'inline-block'; // Show Remove Image button
            };

            if (file) {
                reader.readAsDataURL(file);
            } else {
                preview.src = '';
                preview.style.display = 'none';
                removeButton.style.display = 'none'; // Hide Remove Image button if no file
            }
        }

        // Function to remove the selected image
        function removeImage() {
            document.getElementById('vehicleImage').value = ''; // Clear file input
            document.getElementById('preview').src = ''; // Clear preview
            document.getElementById('preview').style.display = 'none'; // Hide preview
            document.getElementById('removeImageButton').style.display = 'none'; // Hide Remove Image button
        }

        // Click event for #saveVehicleButton
        $('#saveVehicleButton').click(function () {
            // Collect values from vehicle modal fields
            const brandModel = $('#brandModel').val().trim();
            const color = $('#color').val().trim();
            const plateNumber = $('#platenum').val().trim();
            const yearModel = $('#yearmodel').val().trim();
            const transmission = $('#transmission').val();
            const previewSrc = $('#preview').attr('src');  // Get image preview src if it exists

            // Validate required fields
            if (!brandModel || !color || !plateNumber || !yearModel || transmission === "Select Transmission") {
                alert('Please fill out all required vehicle fields.');
                return;
            }

            // Add vehicle data to the global vehicles array
            vehicles.push({
                brandModel: brandModel,
                color: color,
                plateNumber: plateNumber,
                yearModel: yearModel,
                transmission: transmission
            });

            // Create a new vehicle item and append it to the vehicle list
            const vehicleItem = document.createElement('div');
            vehicleItem.className = 'alert alert-info mt-2';
            vehicleItem.innerHTML = `
                <div style="background-color: white; padding: 10px; border-radius: 5px;">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Vehicle ${vehicles.length}:</strong><br><br>
                            <strong>Brand Model:</strong> ${brandModel} <br>
                            <strong>Color:</strong> ${color} <br>
                            <strong>Plate #:</strong> ${plateNumber} <br>
                            <strong>Year Model:</strong> ${yearModel} <br>
                            <strong>Transmission:</strong> ${transmission}
                        </div>
                        <div class="col-md-6">
                            <div class="image-preview mt-2">
                                ${previewSrc && previewSrc !== '#' ? `<img src="${previewSrc}" alt="Vehicle Image" style="max-width:100%; max-height:100%; object-fit: cover;">` : ''}
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <button class="btn btn-warning btn-sm edit-btn">Edit</button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-danger btn-sm delete-btn">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>`;

            document.getElementById('vehicleList').appendChild(vehicleItem);

            // Attach edit and delete event listeners to the new item
            $(vehicleItem).find('.edit-btn').on('click', function () {
                editVehicle(vehicleItem, brandModel, color, plateNumber, yearModel, transmission, previewSrc);
            });
            $(vehicleItem).find('.delete-btn').on('click', function () {
                deleteVehicle(vehicleItem);
            });

            // Reset the form fields and image preview in the modal after saving
            document.getElementById('vehicleForm').reset();
            removeImage();  // Clears image preview
            bootstrap.Modal.getInstance(document.getElementById('vehicleModal')).hide();
        });

        // Function to edit a vehicle entry
        function editVehicle(item, brandModel, color, plateNumber, yearModel, transmission, previewSrc) {
            $('#brandModel').val(brandModel);
            $('#color').val(color);
            $('#platenum').val(plateNumber);
            $('#yearmodel').val(yearModel);
            $('#transmission').val(transmission);
            $('#preview').attr('src', previewSrc).css('display', previewSrc ? 'block' : 'none');
            $('#removeImageButton').css('display', previewSrc ? 'inline-block' : 'none');
            isEditing = true;
            currentItem = item;
            bootstrap.Modal.getInstance(document.getElementById('vehicleModal')).show();
        }

        // Function to delete a vehicle entry
        function deleteVehicle(item) {
            $(item).remove();
            const index = $(item).index();
            vehicles.splice(index, 1);
            renumberVehicles();
        }

        // Function to renumber vehicles after deletion
        function renumberVehicles() {
            $('#vehicleList .alert').each((index, vehicleItem) => {
                $(vehicleItem).find('strong').first().text(`Vehicle ${index + 1}:`);
            });
        }

        // Attach the previewImage function to the file input
        $('#vehicleImage').on('change', previewImage);

        // Remove image button click handler
        $('#removeImageButton').on('click', removeImage);

        // Registration form submission
        $('#registrationForm').submit(function (event) {
            event.preventDefault(); // Prevent the default form submission

            // Capture values from customer information fields
            const name = $('#name').val().trim();
            const phonenumber = $('#phonenumber').val().trim();
            const email = $('#email').val().trim();
            const city = $('#city').val().trim();
            const password = $('#password').val().trim();
            const code = $('#verificationCode').val().trim();

            // Send the captured data to the backend via AJAX
            $.ajax({
                type: 'POST',
                url: '/registration',
                data: JSON.stringify({
                    name: name,
                    phonenumber: phonenumber,
                    email: email,
                    city: city,
                    password: password,
                    vehicles: vehicles,
                    code: code
                }),
                contentType: 'application/json',
                success: function (response) {
                    alert(response.message); // Display success message from the backend
                    if (response.message === 'Account created successfully') {
                        window.location.href = '/homepage.html'; // Redirect to login page on success
                    }
                },
                error: function (xhr, status, error) {
                    // Display an error message if something goes wrong
                    alert('An error occurred: ' + (xhr.responseText || status || error));
                }
            });
        });

        // Get verification code button
        $('#getCodeButton').click(function () {
            const email = $('#email').val();
            
            if (!email) {
                alert('Please enter your email.');
                return;
            }

            // Send code request
            $.ajax({
                type: 'POST',
                url: '/send-code',
                data: JSON.stringify({ email }),
                contentType: 'application/json',
                success: function (response) {
                    alert(response.message);
                },
                error: function (xhr, status, error) {
                    alert('An error occurred while sending the code: ' + (xhr.responseText || status || error));
                }
            });
        });
    });
</script>

    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.10.0/baguetteBox.min.js"></script>
    <script src="assets/js/vanilla-zoom.js"></script>
    <script src="assets/js/theme.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
</body>

</html>
