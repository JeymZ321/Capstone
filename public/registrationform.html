<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Registration Form</title>
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/reynaldoslogo.png">
    <meta name="description" content="This is the Login page">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,400i,700,700i,600,600i">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bebas+Neue&amp;display=swap">
    <link rel="stylesheet" href="assets/css/parallelogram.css">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,400i,700,700i,600,600i">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bebas+Neue&amp;display=swap">
    <link rel="stylesheet" href="assets/fonts/simple-line-icons.min.css">
    <link rel="stylesheet" href="assets/css/about_us_extra.css">
    <link rel="stylesheet" href="assets/css/hover_button.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.10.0/baguetteBox.min.css">
    <link rel="stylesheet" href="assets/css/vanilla-zoom.min.css">

    <style>
         .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .card-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        body{
            background-image: url(assets/img/secondbackgroundindex.png);
        }

        #addVehicleButton{
            background-color: black;
            display: flex;
            justify-content: center; /* Centers horizontally */
            align-items: center;
        }

        .image-preview {
            width: 200px; /* Set fixed width */
            height: 200px; /* Set fixed height */
            border: 1px solid #ccc; /* Optional: add a border */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Ensure content does not overflow */
        }
        .image-preview img {
            max-width: 100%; /* Ensure the image fits within the container */
            max-height: 100%; /* Ensure the image fits within the container */
            object-fit: cover; /* Maintain aspect ratio */
        }

        h3{
            font-family: "Bebas Neue";
            font-weight: lighter;
            font-size: 40px;
        }

        .input-group .form-control {
            border-radius: 20px 0 0 20px;
            border-right: none;
        }

        .input-group .btn {
            border-radius: 0 20px 20px 0;
            background-color: black;
            color: #ffcccc;
            margin-top: 27px;
        }

        .input-group .btn:hover {
            background-color: #333;
        }

        .edit-btn, .delete-btn{
            width: 80%;
            margin: 0 auto;
            align-items: center;
        }

        label{
            font-family: Montserrat;
            font-weight: bold;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"], 
        select{
            width: 500px;
            text-align: left; 
            border: 1px solid #ccc;
            border-radius: 10px;
            box-sizing: border-box;
            padding: 5px;
            margin: 5px;
        }

        .modal-body input[type="text"],
        .modal-body input[type="email"],
        .modal-body input[type="password"], 
        .modal-body select{
            width: 100%;
            box-sizing: border-box; 
        }
       

        
        @media (max-width: 768px) {
        

        input[type="text"],
        input[type="email"],
        input[type="password"], 
        select{
            width: 400px;
        }

        .modal-body input[type="text"],
        .modal-body input[type="email"],
        .modal-body input[type="password"], 
        .modal-body select{
            width: 400px;
            box-sizing: border-box; 
        }
        }
   

    </style>
</head>

<body>
    <nav class="navbar navbar-dark navbar-expand-lg fixed-top clean-navbar" style="background: #051129;">
        <div class="container">
            <img class="img-fluid" src="assets/img/reynaldoslogo.png" width="100px" style="margin: 0px;padding: 0px;" href="index.html">
            <a class="navbar-brand logo" href="index.html"></a>
            <h3 style="color:white;">Registration Form</h3>
        </div>
        
    </nav>
   
    
    <main>
        <div class="parallelogram ">Setting Up Your Account..</div>
        <div class="container" style="margin-top: 200px; padding: 20px;">
            <form id="registrationForm" class="form-container mt-4 mb-5">
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h3 class="mt-4 text-center">Account Details</h3>
                                <div>
                                    <label for="name">Name: <br><input type="text" placeholder="Type your name here.. " name="Name" id="name" required></label>
                                </div>
                                <div>
                                    <label for="name">Email: <br><input type="text" placeholder="Type your email here.. " name="Email" id="email" required></label>
                                </div>
                                <div>
                                    <label for="phonenumber" >Phone #: <br><input type="text" placeholder="+63" name="Phonenumber" id="phonenumber" required></label>
                                </div>
            
                                <div>
                                    <label for="password">Password: <br><input type="password" placeholder="*******"  name="Password" id="password" required></label>
                                </div>
                                <div>
                                    <label for="confirmpassword">Confirm Password: <br><input type="password" placeholder="*******"  name="Password" id="confirmpassword" required></label>
                                </div>

                                <div>
                                    <label for="city">City: <br><input type="text" placeholder="City"  name="City" id="city"></label>
                                </div>
    
                                <div>
                                    <h3 class="mt-4 text-center">Vehicle Information</h3>
                                    <p style="opacity: .7; font-size: 14px;"><i><strong>Note: </strong> We encourage you as our customer to add your vehicle details here for faster appointments. You can add as much as you want!</i></p>

                                    <div class="vehicle-list" id="vehicleList"></div>
                
                                    <button type="button" class="btn btn-primary text-center" id="addVehicleButton" data-bs-toggle="modal" data-bs-target="#vehicleModal" style="margin: 0 auto;">
                                        Add New Vehicle
                                    </button>   
                                    <hr style="width: 80%; height: 3px; background-color: darkred; border: none; margin: 20px auto;">
                                    <div class="mt-4" style="display: flex; justify-content: center;">                                    
                                        <button type="submit" class="btn btn-success mt-4" style="background-color: darkred;">Submit</button>
                                    </div>
                             
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
   
    </main>

<!-- Vehicle Modal -->
<!-- Add Vehicle Modal -->
<div class="modal fade" id="vehicleModal" tabindex="-1" aria-labelledby="vehicleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: darkred; color: white;">
                <h5 class="modal-title" id="vehicleModalLabel">Add Vehicle Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="vehicleForm">
                    <div class="row g-3">
                        <!-- Brand Dropdown -->
                        <div class="col-md-6">
                            <label for="brand" class="form-label">Brand:</label>
                            <select name="Brand" id="brand" class="form-select" required>
                                <option disabled selected>Select a Brand</option>
                            </select>
                        </div>

                        <!-- Model Dropdown -->
                        <div class="col-md-6">
                            <label for="model" class="form-label">Model:</label>
                            <select name="Model" id="model" class="form-select" required>
                                <option disabled selected>Select a Model</option>
                            </select>
                        </div>

                        <!-- Color Dropdown -->
                        <div class="col-md-6">
                            <label for="color" class="form-label">Color:</label>
                            <select name="Color" id="color" class="form-select" onchange="handleColorChange()" required>
                                <option disabled selected>Select a Color</option>
                                <option value="Black">Black</option>
                                <option value="White">White</option>
                                <option value="Silver">Silver</option>
                                <option value="Red">Red</option>
                                <option value="Blue">Blue</option>
                                <option value="Green">Green</option>
                                <option value="Yellow">Yellow</option>
                                <option value="Gray">Gray</option>
                                <option value="Brown">Brown</option>
                                <option value="Others">Others</option>
                            </select>
                            <input type="text" id="customColor" name="CustomColor" class="form-control mt-2" placeholder="Specify Color" style="display: none;">
                        </div>

                        <!-- Plate Number -->
                        <div class="col-md-6">
                            <label for="platenum" class="form-label">Plate Number:</label>
                            <input type="text" name="PlateNumber" id="platenum" class="form-control" placeholder="ABC 1234" maxlength="8" required>
                        </div>

                        <!-- Year Model Dropdown -->
                        <div class="col-md-6">
                            <label for="yearModel" class="form-label">Year Model:</label>
                            <select name="YearModel" id="yearModel" class="form-select" required>
                                <option disabled selected>Select a Year Model</option>
                                <!-- Generate years dynamically -->
                                <script>
                                    const yearDropdown = document.getElementById('yearModel');
                                    const currentYear = new Date().getFullYear();
                                    for (let year = currentYear; year >= 1900; year--) {
                                        const option = document.createElement('option');
                                        option.value = year;
                                        option.textContent = year;
                                        yearDropdown.appendChild(option);
                                    }
                                </script>
                            </select>
                        </div>

                        <!-- Transmission Dropdown -->
                        <div class="col-md-6">
                            <label for="transmission" class="form-label">Transmission:</label>
                            <select name="Transmission" id="transmission" class="form-select" required>
                                <option disabled selected>Select Transmission</option>
                                <option value="Automatic">Automatic</option>
                                <option value="Manual">Manual</option>
                                <option value="CVT">CVT</option>
                                <option value="Dual Clutch">Dual Clutch</option>
                            </select>
                        </div>

                        <!-- Vehicle Image -->
                        <div class="col-md-12">
                            <label for="vehicleImage" class="form-label">Vehicle Image (optional):</label>
                            <input type="file" accept="image/*" id="vehicleImage" class="form-control" onchange="previewImage(event)">
                            <div id="imagePreview" class="mt-3 text-center">
                                <img id="preview" src="#" alt="Image Preview" class="img-fluid" style="display: none; max-width: 100%; height: auto;">
                            </div>
                            <button type="button" class="btn btn-danger mt-2" id="removeImageButton" onclick="removeImage()" style="display: none;">Remove Image</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveVehicleButton" style="background-color: #051129;">Save Vehicle</button>
            </div>
        </div>
    </div>
</div>

    
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
<script>
    let vehicles = [];  // Global array to store all vehicle information
    let vehicleCount = 0;
    let isEditing = false;
    let currentItem = null; // Store the item being edited

    

function toggleSidebar() {
    document.getElementById("sidebar").classList.toggle("minimized");
}

function handleColorChange() {
        const colorDropdown = document.getElementById("color");
        const customColorInput = document.getElementById("customColor");
        
        // Show the custom color input if "Others" is selected
        if (colorDropdown.value === "Others") {
            customColorInput.style.display = "block";
            customColorInput.required = true;
        } else {
            customColorInput.style.display = "none";
            customColorInput.required = false;
        }
    }

    function previewImage(event) {
    const fileInput = event.target; 
    const preview = document.getElementById('preview'); 
    const removeButton = document.getElementById('removeImageButton'); 
    const file = fileInput.files[0]; 

    if (file) {
        const reader = new FileReader();
        reader.onload = function () {
            preview.src = reader.result;
            preview.style.display = 'block';
            removeButton.style.display = 'inline-block';
        };
        reader.readAsDataURL(file);
    } else {
        preview.src = '';
        preview.style.display = 'none';
        removeButton.style.display = 'none';
    }
}
// Remove image function
function removeImage() {
    document.getElementById('vehicleImage').value = '';
    previewImage({ target: { files: [] } });
    document.getElementById('preview').src = '';
    document.getElementById('preview').style.display = 'none';
    document.getElementById('removeImageButton').style.display = 'none';
}

$(document).ready(function () {
    $('#removeImageButton').on('click', removeImage);
});

///////////////////////////////////////////////////////////////////////////////////////////////////

$(document).ready(function () {
    
    // Function to update dropdowns with car data
    async function updateCarDropdowns() {
        try {
            const response = await fetch('/api/carmodels');
            if (!response.ok) throw new Error(`Failed to fetch car models. Status: ${response.status}`);

            const cars = await response.json();
            console.log('Fetched car models:', cars); // Debugging output

            const brandDropdown = document.getElementById('brand');
            const modelDropdown = document.getElementById('model');

            // Reset dropdowns
            brandDropdown.innerHTML = '<option disabled selected>Select a Brand</option>';
            modelDropdown.innerHTML = '<option disabled selected>Select a Model</option>';

            if (cars.length === 0) {
                console.warn('No car models found in the database.'); // Warning if no cars
                return;
            }

            // Populate unique brands
            const brands = [...new Set(cars.map(car => car.brand))];
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandDropdown.appendChild(option);
            });

            // Event listener to update models based on selected brand
            brandDropdown.addEventListener('change', () => {
                const selectedBrand = brandDropdown.value;
                const models = cars.filter(car => car.brand === selectedBrand).map(car => car.model);

                modelDropdown.innerHTML = '<option disabled selected>Select a Model</option>';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelDropdown.appendChild(option);
                });

                console.log(`Models for brand "${selectedBrand}":`, models); // Debugging output
            });

            console.log('Dropdowns updated successfully');
        } catch (error) {
            console.error('Error updating car dropdowns:', error);
            alert('Failed to load car data. Please try again later.');
        }
    }

    // Call updateCarDropdowns on page load
    updateCarDropdowns();





    // Save Vehicle Button Click
    $('#saveVehicleButton').click(function () {
        const brand = $('#brand').val()?.trim() || '';
        const model = $('#model').val()?.trim() || '';
        const color = $('#color').val()?.trim() || '';
        const customColor = (color === 'Others') ? $('#customColor').val()?.trim() || '' : '';
        const plateNumber = $('#platenum').val()?.trim() || '';
        const yearModel = $('#yearModel').val()?.trim() || '';
        const transmission = $('#transmission').val() || '';
        const imageFile = $('#vehicleImage')[0]?.files[0];

        // Validation
        if (!brand || !model || !color || !plateNumber || !yearModel || transmission === "Select Transmission") {
            alert('Please fill out all required vehicle fields.');
            return;
        }
        if (color === 'Others' && !customColor) {
            alert('Please specify the custom color.');
            return;
        }

        // Add the vehicle to the global vehicles array
        vehicles.push({
            brand,
            model,
            color: color === 'Others' ? customColor : color,
            plateNumber,
            yearModel,
            transmission,
            imageUrl: imageFile ? URL.createObjectURL(imageFile) : null,
        });

        // Update Vehicle List in UI
        const vehicleList = $('#vehicleList');
        const vehicleItem = $(`
            <div style="background-color: white; padding: 10px; border-radius: 5px;">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Vehicle ${vehicles.length}:</strong><br><br>
                        <strong>Brand:</strong> ${brand} <br>
                        <strong>Model:</strong> ${model} <br>
                        <strong>Color:</strong> ${color === 'Others' ? customColor : color} <br>
                        <strong>Plate #:</strong> ${plateNumber} <br>
                        <strong>Year Model:</strong> ${yearModel} <br>
                        <strong>Transmission:</strong> ${transmission}
                    </div>
                    <div class="col-md-6">
                        <div class="image-preview mt-2">
                            ${imageFile ? `<img src="${URL.createObjectURL(imageFile)}" alt="Vehicle Image" style="max-width:100%; max-height:100%; object-fit: cover;">` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `);
        vehicleList.append(vehicleItem);

        // Reset Form
        $('#vehicleForm')[0].reset();
        $('#preview').attr('src', '').hide();
        $('#removeImageButton').hide();
        bootstrap.Modal.getInstance(document.getElementById('vehicleModal')).hide();
    });

    // Registration Form Submission
    $('#registrationForm').submit(function (event) {
        event.preventDefault(); // Prevent default form submission

        // Capture Customer Data
        const name = $('#name').val().trim();
        const phonenumber = $('#phonenumber').val().trim();
        const email = $('#email').val().trim();
        const city = $('#city').val().trim();
        const password = $('#password').val().trim();

        // Validate Customer Data
        if (!name || !phonenumber || !email || !password) {
            alert('Please fill out all required fields.');
            return;
        }

        if (vehicles.length === 0) {
            alert('Please add at least one vehicle.');
            return;
        }

        // Prepare User Data
        const userData = {
            name,
            phonenumber,
            email,
            city,
            password,
            vehicles,
        };

        console.log('Final User Data Sent:', userData);

        // Send the data to the backend
        $.ajax({
            type: 'POST',
            url: '/registration',
            data: JSON.stringify(userData),
            contentType: 'application/json',
            success: function (response) {
                alert(response.message);
                if (response.message) {
                    localStorage.setItem('userEmail', email);
                    window.location.href = '/homepage.html'; // Redirect on success
                }
            },
            error: function (xhr, status, error) {
                alert('An error occurred: ' + (xhr.responseText || status || error));
            },
        });
    });

    // Image Preview Handlers
    $('#vehicleImage').on('change', previewImage);
    $('#removeImageButton').on('click', removeImage);

    function previewImage(event) {
        const fileInput = event.target;
        const preview = document.getElementById('preview');
        const removeButton = document.getElementById('removeImageButton');
        const file = fileInput.files[0];

        if (file) {
            const reader = new FileReader();
            reader.onload = function () {
                preview.src = reader.result;
                preview.style.display = 'block';
                removeButton.style.display = 'inline-block';
            };
            reader.readAsDataURL(file);
        } else {
            preview.src = '';
            preview.style.display = 'none';
            removeButton.style.display = 'none';
        }
    }

    function removeImage() {
        $('#vehicleImage').val('');
        $('#preview').attr('src', '').hide();
        $('#removeImageButton').hide();
    }
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Function to get query parameters
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Extract the token from the URL
        const token = getQueryParam('token');
        if (token) {
            try {
                // Decode the token to get the email
                const decoded = jwt_decode(token);
                if (decoded.email) {
                    // Pre-fill the email field
                    document.getElementById('email').value = decoded.email;
                } else {
                    console.error('Email not found in token.');
                }
            } catch (error) {
                console.error('Invalid token:', error);
            }
        } else {
            console.warn('Token not found in URL.');
        }
    });
</script>


    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.10.0/baguetteBox.min.js"></script>
    <script src="assets/js/vanilla-zoom.js"></script>
    <script src="assets/js/theme.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css">
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
</body>

</html>
